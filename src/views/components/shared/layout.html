<!-- Navigation -->
<nav class="nav">
    <div class="nav__container">
        <div class="nav__left">
            <button id="hamburger" class="nav__toggle" aria-label="Toggle Menu">&#9776;</button>
        </div>
        <div class="nav__menu">
            <span id="userName" class="nav__link user-name">User</span>
            <div id="navMenu" class="nav__dropdown" hidden>
                <button class="nav__dropdown-item" id="logoutBtn">Logout</button>
            </div>
        </div>
    </div>
</nav>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
    <a href="javascript:void(0)" class="sidebar__close" id="close-sidebar" aria-label="Close Menu">&times;</a>
    <div class="sidebar__brand">
        <img id="logo" alt="Quantum Eye Logo" style="max-width: 100%; height: auto;">
    </div>
    <div id="menu-items">
        <a href="#" class="sidebar__link admin-only" data-path="adminControlPanel">Genesis Admin Control Panel</a>
        <div class="sidebar__form admin-only">
            <h3 class="sidebar__form-title">Create User</h3>
            <form id="admin-creation-form">
                <div class="sidebar__form-group">
                    <label class="sidebar__label" for="username">Username</label>
                    <input class="sidebar__input" type="text" id="username" name="username" required autocomplete="username">
                </div>
                <div class="sidebar__form-group">
                    <label class="sidebar__label" for="email">Email</label>
                    <input class="sidebar__input" type="email" id="email" name="email" required autocomplete="email">
                </div>
                <div class="sidebar__form-group">
                    <label class="sidebar__label" for="password">Password</label>
                    <input class="sidebar__input" type="password" id="password" name="password" required autocomplete="new-password">
                </div>
                <div class="sidebar__form-group">
                    <label class="sidebar__label" for="role">Role</label>
                    <select class="sidebar__input" id="role" name="role" required>
                        <option value="">Select Role</option>
                        <option value="Platform Admin">Platform Admin</option>
                        <option value="User Admin">User Admin</option>
                        <option value="User">User</option>
                    </select>
                </div>
                <div class="sidebar__form-group">
                    <button type="submit" class="button button--primary button--full">Create User</button>
                </div>
            </form>
            <div id="error-message" class="sidebar__message sidebar__message--error"></div>
        </div>
        <a href="#" class="sidebar__link" data-path="settings">Settings</a>
        <a href="#" class="sidebar__link" data-path="userProfile">User Profile</a>
    </div>
    <div class="sidebar__footer">
        <a href="#" class="sidebar__link logout-link">Logout</a>
        <a href="#" class="sidebar__link exit-button">Exit</a>
    </div>
</div>

<script type="module">
    import paths from '../../../config/paths.js';

    // Import modules using paths.resolve with isModule=true
    Promise.all([
        import(paths.resolve('src/services/navigation/navigation.js', true)),
        import(paths.resolve('src/models/user.js', true)),
        import(paths.resolve('src/controllers/admin/admincontrolpanel.js', true))
    ]).then(([
        { default: navigation },
        { User },
        { AdminControlPanel }
    ]) => {
        // Setup logo path
        const logo = document.getElementById('logo');
        if (logo) {
            logo.src = paths.getAssetPath('logo');
        }

        // Setup navigation paths
        const menuLinks = document.querySelectorAll('.sidebar__link[data-path]');
        menuLinks.forEach(link => {
            const pageName = link.getAttribute('data-path');
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigation.navigateToPage(pageName);
            });
        });

        // Setup hamburger menu toggle
        const hamburger = document.getElementById('hamburger');
        if (hamburger) {
            hamburger.addEventListener('click', () => {
                navigation.toggleSidebar();
            });
        }

        // Setup close button
        const closeBtn = document.getElementById('close-sidebar');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                navigation.closeSidebar();
            });
        }

        // Setup logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        const logoutLink = document.querySelector('.logout-link');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', () => {
                User.logout();
                navigation.navigateToPage('login');
            });
        }
        if (logoutLink) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                User.logout();
                navigation.navigateToPage('login');
            });
        }

        // Setup exit functionality
        const exitButton = document.querySelector('.exit-button');
        if (exitButton) {
            exitButton.addEventListener('click', (e) => {
                e.preventDefault();
                window.close();
            });
        }

        // Set active link based on current page
        const currentPath = window.location.pathname;
        menuLinks.forEach(link => {
            const pagePath = link.getAttribute('data-path');
            if (currentPath.includes(pagePath)) {
                link.classList.add('active');
            } else {
                link.classList.remove('active');
            }
        });

        // Function to update username display
        function updateUsername() {
            const userNameEl = document.getElementById('userName');
            if (userNameEl) {
                const currentUser = User.getCurrentUser();
                if (currentUser && currentUser.username) {
                    userNameEl.textContent = currentUser.username;
                }
            }
        }

        // Update username on initial load
        updateUsername();

        // Listen for userDataReady event to update username
        document.addEventListener('userDataReady', (event) => {
            updateUsername();
            
            // Show/hide admin-only elements
            const userRole = event.detail.role;
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = userRole === 'Genesis Admin' ? 'block' : 'none';
            });

            // Initialize form handler if admin
            if (userRole === 'Genesis Admin') {
                const form = document.getElementById('admin-creation-form');
                if (form) {
                    new AdminControlPanel().setupFormHandler();
                }
            }
        });

        // Ensure sidebar starts closed
        navigation.closeSidebar();
    }).catch(error => {
        console.error('Error loading modules:', error);
    });
</script>
