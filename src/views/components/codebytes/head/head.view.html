<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Quantum Eye - Advanced Research Platform">
<meta name="theme-color" content="#ffffff">
<title>{{pageTitle}} - Quantum Eye</title>

<!-- Import paths -->
<script type="module">
    import paths from '/config/paths.js';
    window.paths = paths; // Make paths available globally
</script>

<!-- Theme initialization - Must be first -->
<script type="module">
    import ThemeManager from '/src/services/state/thememanager.js';
    // Apply theme immediately before any content loads
    ThemeManager.initialize();
</script>

<!-- Load CSS files -->
<script>
    // Load all CSS files from environment paths
    const loadStyles = () => {
        const allStyles = [
            ...window.env.STYLE_PATHS.base,
            ...window.env.STYLE_PATHS.layouts,
            ...window.env.STYLE_PATHS.components,
            ...window.env.STYLE_PATHS.utilities
        ];

        allStyles.forEach(href => {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = window.env.PathResolver.resolve(href);
            document.head.appendChild(link);
        });
    };

    // Execute style loading
    loadStyles();
</script>

<style>
    /* Ensure smooth theme transitions */
    :root {
        transition: background-color var(--transition-speed) ease,
                    color var(--transition-speed) ease;
    }

    /* Ensure theme colors are inherited */
    html, body {
        background-color: var(--color-surface-primary);
        color: var(--color-text-primary);
        min-height: 100vh;
    }
</style>

<!-- Initialize User Model -->
<script type="module">
    const { User } = await import(paths.resolve('src/models/user.js'));
    const { default: ThemeManager } = await import(paths.resolve('src/services/state/thememanager.js'));
    const { default: FontManager } = await import(paths.resolve('src/services/state/fontmanager.js'));

    // Make User model available globally
    window.QE = window.QE || {};
    window.QE.User = User;

    // Initialize managers
    try {
        console.log('Initializing ThemeManager');
        ThemeManager.initialize();
        console.log('ThemeManager initialized');
        
        console.log('Initializing FontManager');
        FontManager.initialize();
        console.log('FontManager initialized');
    } catch (error) {
        console.error('Error initializing managers:', error);
    }

    // Initialize user data if authenticated
    if (User.isAuthenticated()) {
        try {
            const currentUser = User.getCurrentUser();
            if (currentUser) {
                // Store user data in a global object
                window.QE.currentUser = currentUser;
                window.QE.userRole = currentUser.role;
                
                // Initialize theme and font based on user preferences
                const preferences = User.getUserPreferences();
                if (preferences) {
                    console.log('Setting theme:', preferences.theme);
                    if (preferences.theme) {
                        ThemeManager.setTheme(preferences.theme);
                    }
                    
                    console.log('Setting font:', preferences.fontFamily);
                    if (preferences.fontFamily) {
                        FontManager.setFont(preferences.fontFamily);
                    }
                }

                // Dispatch event when user data is ready
                document.dispatchEvent(new CustomEvent('userDataReady', {
                    detail: {
                        user: currentUser,
                        role: currentUser.role,
                        preferences: preferences
                    }
                }));
            }
        } catch (error) {
            console.error('Error initializing user data:', error);
        }
    }

    // Listen for theme changes
    window.addEventListener('storage', (event) => {
        try {
            if (event.key === 'theme_change') {
                const data = JSON.parse(event.newValue || '{}');
                if (data.theme) {
                    ThemeManager.applyTheme(data.theme);
                }
            }
        } catch (error) {
            console.error('Error handling theme change:', error);
        }
    });

    // Listen for font changes
    window.addEventListener('storage', (event) => {
        try {
            if (event.key?.startsWith('user_preferences_')) {
                const preferences = JSON.parse(event.newValue || '{}');
                if (preferences.fontFamily) {
                    FontManager.applyFont(preferences.fontFamily);
                }
            }
        } catch (error) {
            console.error('Error handling font change:', error);
        }
    });

    // Listen for user data changes
    window.addEventListener('storage', (event) => {
        try {
            if (event.key === 'currentUser' || event.key === 'users_csv' || event.key === 'users_json') {
                // Reload user data
                const currentUser = User.getCurrentUser();
                if (currentUser) {
                    window.QE.currentUser = currentUser;
                    window.QE.userRole = currentUser.role;
                    
                    // Dispatch event for components to update
                    document.dispatchEvent(new CustomEvent('userDataUpdated', {
                        detail: {
                            user: currentUser,
                            role: currentUser.role
                        }
                    }));
                }
            }
        } catch (error) {
            console.error('Error handling user data change:', error);
        }
    });

    // Add page-specific styles
    const additionalStyles = `{{additionalStyles}}`;
    if (additionalStyles) {
        const style = document.createElement('style');
        style.textContent = additionalStyles;
        document.head.appendChild(style);
    }

    // Dispatch event when head is ready
    document.dispatchEvent(new CustomEvent('headReady'));
    console.log('Common head content loaded successfully');
</script>
